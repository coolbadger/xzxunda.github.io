---
layout: base_page
title: 农机跟踪
---

{% include mapScript.html %}
{% include temp/control_head.html %}
{% include common/canvas.html %}
<div style="height: 100%;width: 100%">
    <div class="row" style="width:50%;height: 100%;float: left;padding-left: 20px;">
        <div class="col-md-12" style="height: 4%;">

        </div>
        <div class="col-md-6" >
            {% include temp/textbox.html id='machCode' text='农机:' placeholder='请输入农机车牌号或类型' showButton = true
            onclick='onSearchClick()' onTextChange='onAutoSearch(value)' %}
        </div>
        <div class="col-md-12" style="height: 2%;">

        </div>
        <div class="col-md-12" >
            {% include temp/simple_table.html %}
        </div>
    </div>
</div>

<div id="row" style="width: 50%;height: 100%;float: right; border: 0px solid red;">
    <div class="col-md-12" style="height: 4%;">

    </div>
    <div class="col-md-12" id="columnChart-box" >
        {% include temp/chart.html id='columnChart' heading='柱形图'%}
    </div>

    <div class="col-md-12" style="height: 11%;">

    </div>


    <div class="col-md-12">
        {% include temp/chart.html id='pieChart' heading='饼图'%}
    </div>
</div>

<script type="text/javascript">
    var apiObjUrl = API_URL + '/api/gpsRecords';
    var general_data=new Object();
    var simpleTableGen = new SimpleTableGen();
    var settings = new Object();
    settings.columns = [{
        field: 'machCode',
        title: '车号',
        align: 'center',
    }, {
        field: 'machName',
        title: '车型',
        align: 'center',
    }, {
        field: 'workArea',
        title: '作业面积/亩',
        align: 'center',
    }, {
        field: 'workTime',
        title: '作业时间/小时',
        align: 'center',
    }];

    var jsonData ="[";
    var nm_drivingArea = 0;
    var nm_workArea = 0;
    var machCodes;
    settings.onDblClickRow = function (row, $element) {

        $("#process").fadeIn('fast', function () {
            $.when(onRowDbClick(row, $element)).done(
                    function () {
                        $("#process").fadeOut();
                    }
            );
        });
    }

    function onRowDbClick(row, $element) {
        var a=1;
        nm_drivingArea=row.drivingArea;
        nm_workArea=row.workArea;
        machCodes = row.machCode
        columnChart(a);

    }




    var currentTime = getCurrentDate(1, true);
    var fullData = null;
    var machCode = "";

    simpleTableGen.settings = settings;
    simpleTableGen.apiName = "";
    simpleTableGen.url = apiObjUrl + "?startTime=2016-12-04 00:00:00&endTime=" + currentTime + "&machCode=" + machCode;

    //获取数据，初始化数据
    simpleTableGen.initData = function () {
        var requestUrl = encodeURI(apiObjUrl + "?startTime=2016-12-04 00:00:00&endTime=" + currentTime + "&machCode=" + machCode);
        $.ajax({
            url: apiObjUrl+"/gpsDataAnalysis",
            type: 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", $.cookie('author_code'));
            },
            success: function (data) {
                var map = new BMap.Map("map_container");            // 创建地图实例
                var point = new BMap.Point(117.606257, 34.042178);  // 创建点坐标(目前为双沟镇政府)
                var temp_sensor1=[];
                var temp=[];
                var temp_data=[];
                var distance;
                var mm_distance = 0;
                var workTime = 0;
                var total_number = 0;
                var reMachTerminalId;

                for(var i=0;i<data.length;i++){
                    if(temp.length<1){
                        if(i>0){
                            temp.push(data[i]);
                            temp.push(data[i-1]);
                        }else{
                            temp.push(data[i]);
                        }
                    }else{
                        if(data[i].reMachTerminalId==data[i-1].reMachTerminalId){
                            temp.push(data[i]);//相同农机GPS数据
                        }else{
                            temp_data.push("machCode"+temp[0].machCode)
                            temp_data.push("machName"+temp[0].machName)
                            temp_data.push("workTime"+((temp[temp.length-1].gpsTime-temp[0].gpsTime)/(1000*60*60)).toFixed(2))


                            for(var ii=0;ii<temp.length;ii++){
                                if(ii>=1){
                                    //行驶距离
                                    var pointA = new BMap.Point(temp[ii].lngFixed, temp[ii].latFixed);  // 创建点坐标
                                    var pointB = new BMap.Point(temp[ii - 1].lngFixed, temp[ii - 1].latFixed);  // 创建点坐标
                                    var mm = parseFloat((map.getDistance(pointA, pointB)).toFixed(2));
                                    mm_distance +=mm;
                                }

                                if(temp[ii].sensor1=='1'){
                                    temp_sensor1.push(temp[ii]);
                                }else{
                                    if(temp_sensor1.length>0){
                                        for(var a=0;a<temp_sensor1.length;a++){
                                            if(a>=1) {
                                                //工作距离
                                                var pointA = new BMap.Point(temp_sensor1[a].lngFixed, temp_sensor1[a].latFixed);  // 创建点坐标
                                                var pointB = new BMap.Point(temp_sensor1[a - 1].lngFixed, temp_sensor1[a - 1].latFixed);  // 创建点坐标
                                                var mm = parseFloat((map.getDistance(pointA, pointB)).toFixed(2));
                                                distance += mm;//累加距离
                                            }
                                        }
                                        total_number += distance;
                                    }
                                    distance=0;
                                    temp_sensor1=[];
                                }
                            }

                            console.log( temp.length)
                            jsonData +="{"+ "drivingArea:"+((mm_distance*3*15)/10000).toPrecision(3)+","+"machCode:"+"'"+temp[0].machCode+"'"+","+"machName:"+"'"+temp[0].machName+"'"+","+"workTime:"+((temp[temp.length-1].gpsTime-temp[0].gpsTime)/(1000*60*60)).toFixed(2)+","+"workArea:"+((total_number*3*15)/10000).toPrecision(3) + "}"+",";
                            temp_data.push("workArea"+((total_number*3*15)/10000).toPrecision(3))
                            mm_distance=0
                            total_number=0;
                            temp=[];
                        }
                    }

                }

                if(temp.length>0){
                    var total_numbers=0;
                    for(var ii=0;ii<temp.length;ii++){
                        if(ii>=1){
                            //行驶距离
                            var pointA = new BMap.Point(temp[ii].lngFixed, temp[ii].latFixed);  // 创建点坐标
                            var pointB = new BMap.Point(temp[ii - 1].lngFixed, temp[ii - 1].latFixed);  // 创建点坐标
                            var mm = parseFloat((map.getDistance(pointA, pointB)).toFixed(2));
                            mm_distance +=mm;
                        }

                        if(temp[ii].sensor1=='1'){
                            temp_sensor1.push(temp[ii]);
                        }else{
                            if(temp_sensor1.length>0){
                                for(var a=0;a<temp_sensor1.length;a++){
                                    if(a>=1) {
                                        var pointA = new BMap.Point(temp_sensor1[a].lngFixed, temp_sensor1[a].latFixed);  // 创建点坐标
                                        var pointB = new BMap.Point(temp_sensor1[a - 1].lngFixed, temp_sensor1[a - 1].latFixed);  // 创建点坐标
                                        var mm = parseFloat((map.getDistance(pointA, pointB)).toFixed(2));
                                        distance += mm;//累加距离
                                    }
                                }
                                total_numbers += distance;

                            }
                            distance=0;
                            temp_sensor1=[];
                        }
                    }
                    console.log( temp.length)
                    jsonData +="{"+"drivingArea:"+((mm_distance*3*15)/10000).toPrecision(3)+","+"machCode:"+"'"+temp[0].machCode+"'"+","+"machName:"+"'"+temp[0].machName+"'"+","+"workTime:"+((temp[temp.length-1].gpsTime-temp[0].gpsTime)/(1000*60*60)).toFixed(2)+","+"workArea:"+((total_numbers*3*15)/10000).toPrecision(3)+"}"+",";
                }

                jsonData +="]";
                console.log(jsonData)
                var json = eval('(' + jsonData + ')');
                general_data=json;
                simpleTableGen.table.bootstrapTable('load', json);
                pieChart();
                columnChart();
            },
            error: function (err) {
            }
        });
    };
    simpleTableGen.bind();


    // 自动查询本地缓存结果
    function onAutoSearch(value) {
        if (fullData == null) {
            fullData = simpleTableGen.table.bootstrapTable('getData');
        }
        var newData = new Array();
        fullData.forEach(function (item) {
            if (item.machCode.indexOf(value) > 0 || item.machName.indexOf(value) > 0) {
                newData.push(item);
                console.log(newData)
            }
        });
        var checkCondition = value.length > machCode.length && value.indexOf(machCode) > 0 || (machCode.length == 0 && value.length > 0);
        if (checkCondition) {
            simpleTableGen.table.bootstrapTable('load', newData);
        }
        else {
            simpleTableGen.table.bootstrapTable('load', fullData);
        }
//        cleanAllInfo();
    }


    function columnChart(a) {
        if(a!=1) {
             nm_drivingArea = 0;
             nm_workArea = 0;

            for (var i = 0; i < general_data.length; i++) {
                nm_drivingArea += general_data[i].drivingArea;
                nm_workArea += general_data[i].workArea;
            }
        }

        var chart = new CanvasJS.Chart("columnChart");
        chart.options.title = {text: "所有作业面积分析柱形图"};
        chart.options.data = [];
        var series1 = {type: "column", name: "First Quarter"};

        chart.options.data.push(series1);
        if(a!=1){
        series1.dataPoints = [
            {label: "农机工作面积", y: nm_drivingArea},
            {label: "农机有效作业面积", y:nm_workArea }
        ];}else{
            series1.dataPoints = [
            {label: machCodes+"农机工作面积", y: nm_drivingArea},
            {label: machCodes+"农机有效作业面积", y:nm_workArea }];
        }
        chart.render();
    }


    function pieChart() {
        var dataTime="[";
        for(var i=0;i<general_data.length;i++){
            dataTime +="{"+"y:"+general_data[i].workTime+","+"legendText:"+"'"+general_data[i].machName+general_data[i].machCode+"'"+","+"indexLabel:"+"'"+general_data[i].machName+general_data[i].machCode+"'"+"}"+","
        }
        dataTime +="]";
console.log(dataTime)
        var j = eval('(' + dataTime + ')');
        var chart = new CanvasJS.Chart("pieChart",
                {
                    title: {
                        text: "农机工作时间"
                    },
                    animationEnabled: true,
                    legend: {
                        verticalAlign: "bottom",
                        horizontalAlign: "center"
                    },
                    data: [
                        {
                            indexLabelFontSize: 20,
                            indexLabelFontFamily: "Monospace",
                            indexLabelFontColor: "darkgrey",
                            indexLabelLineColor: "darkgrey",
                            indexLabelPlacement: "outside",
                            type: "pie",
                            showInLegend: true,
                            toolTipContent: "{y} - <strong>#percent%</strong>",
                            dataPoints: j
                        }
                    ]
                });
        chart.render();
    }

</script>