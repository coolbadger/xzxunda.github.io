---
layout: base_page
title: 农机跟踪
---

{% include mapScript.html %}
{% include temp/control_head.html %}
{% include common/canvas.html %}
<div style="height: 100%;width: 100%">
    <div class="row" style="width:50%;height: 100%;float: left;padding-left: 20px;">
        <div class="col-md-12" style="height: 4%;">

        </div>
        <div class="col-md-6" >
            {% include temp/textbox.html id='machCode' text='农机:' placeholder='请输入农机车牌号或类型' showButton = true
            onclick='onSearchClick()' onTextChange='onAutoSearch(value)' %}
        </div>
        <div class="col-md-12" style="height: 2%;">

        </div>
        <div class="col-md-12" style="overflow: scroll; height: 100%">
            {% include temp/simple_table.html %}
        </div>

    </div>
</div>

<div id="row" style="width: 50%;height: 100%;float: right; border: 0px solid red;">
    <div class="col-md-12" style="height: 4%;">

    </div>
    <div class="col-md-12" id="columnChart-box" >
        {% include temp/chart.html id='columnChart' heading='柱形图'%}
    </div>

    <div class="col-md-12" style="height: 11%;">

    </div>


    <div class="col-md-12">
        {% include temp/chart.html id='pieChart' heading='饼图'%}
    </div>
</div>

<script type="text/javascript">
    var apiObjUrl = API_URL + '/api/DetailsPage';
    var general_data=new Object();
    var simpleTableGen = new SimpleTableGen();
    var settings = new Object();
    settings.columns = [{
        field: 'id',
        title: 'id',
        align: 'center',
    },{
        field: 'orgName',
        title: '合作社',
        align: 'center',
    }, {
        field: 'orgAddress',
        title: '地址',
        align: 'center',
    }, {
        field: 'machSize',
        title: '农机数/辆',
        align: 'center',
    }, {
        field: 'allDrivingArea',
        title: '工作面积/亩',
        align: 'center',
    }
        , {
            field: 'allWorkArea',
            title: '有效工作面积/亩',
            align: 'center',
        }
        , {
            field: 'allWorkTime',
            title: '工作时间/小时',
            align: 'center',
        }
    ];


    settings.onDblClickRow = function (row, $element) {

        $("#process").fadeIn('fast', function () {
            $.when(onRowDbClick(row, $element)).done(
                    function () {
                        $("#process").fadeOut();
                    }
            );
        });
    }

    function onRowDbClick(row, $element) {
        $.ajax({
            url: apiObjUrl+"/"+row.id,
            type: 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", $.cookie('author_code'));
            },
            success: function (data) {
                console.log(data)
                simpleTableGen.table.bootstrapTable('removeAll');
            },
            error: function (err) {
            }
        });
        columnChart(row,1);

    }




    var currentTime = getCurrentDate(1, true);
    var fullData = null;
    var machCode = "";

    simpleTableGen.settings = settings;
    simpleTableGen.apiName = "";
    simpleTableGen.url = apiObjUrl + "?startTime=2016-12-04 00:00:00&endTime=" + currentTime + "&machCode=" + machCode;

    //获取数据，初始化数据
    simpleTableGen.initData = function () {
        var requestUrl = encodeURI(apiObjUrl + "?startTime=2016-12-04 00:00:00&endTime=" + currentTime + "&machCode=" + machCode);
        $.ajax({
            url: apiObjUrl,
            type: 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", $.cookie('author_code'));
            },
            success: function (data) {
                var jsonData="[";
                for(var i=0;i<data.length;i++){
                    jsonData+="{"+"id:"+"'"+data[i].id+"'"+","+"orgName:"+"'"+data[i].orgName+"'"+","+"orgAddress:"+"'"+data[i].orgAddress+"'"+","+"machSize:"+"'"+data[i].machSize+"'"+","+"allDrivingArea:"+"'"+data[i].allDrivingArea+"'"+","+"allWorkArea:"+"'"+data[i].allWorkArea+"'"+","+"allWorkTime:"+"'"+data[i].allWorkTime+"'"+"}"+","
                }
                jsonData+="]";
                var json = eval('(' + jsonData + ')');
                general_data=json;
                simpleTableGen.table.bootstrapTable('load', json);
               pieChart(data);
                columnChart(data);
            },
            error: function (err) {
            }
        });
    };
    simpleTableGen.bind();


    // 自动查询本地缓存结果
    function onAutoSearch(value) {
        if (fullData == null) {
            fullData = simpleTableGen.table.bootstrapTable('getData');
        }
        var newData = new Array();
        fullData.forEach(function (item) {
            if (item.machCode.indexOf(value) > 0 || item.machName.indexOf(value) > 0) {
                newData.push(item);
            }
        });
        var checkCondition = value.length > machCode.length && value.indexOf(machCode) > 0 || (machCode.length == 0 && value.length > 0);
        if (checkCondition) {
            simpleTableGen.table.bootstrapTable('load', newData);
        }
        else {
            simpleTableGen.table.bootstrapTable('load', fullData);
        }
//        cleanAllInfo();
    }


    function columnChart(data,a) {
        var tempAllDrivingArea=0;
        var tempAllWorkArea=0;
            for(var i=0;i<data.length;i++){
                tempAllDrivingArea += parseFloat(data[i].allDrivingArea);
                tempAllWorkArea+=parseFloat(data[i].allWorkArea);
            }
            if(a==1){
                tempAllWorkArea=parseFloat(data.allWorkArea);
                tempAllDrivingArea=parseFloat(data.allDrivingArea);
            }
        var chart = new CanvasJS.Chart("columnChart");
        chart.options.title = {text: "所有作业面积分析柱形图"};
        chart.options.data = [];
        var series1 = {type: "column", name: "First Quarter"};

        chart.options.data.push(series1);
            series1.dataPoints = [
                {label: "农机工作面积", y: tempAllDrivingArea},
                {label: "农机有效作业面积", y:tempAllWorkArea }
            ];
        chart.render();
    }


    function pieChart(data) {
        var dataTime="[";
        for(var i=0;i<data.length;i++){
            dataTime +="{"+"y:"+data[i].allWorkTime+","+"legendText:"+"'"+data[i].orgName+"'"+","+"indexLabel:"+"'"+data[i].orgName+"'"+"}"+","
        }
        dataTime +="]";
        var j = eval('(' + dataTime + ')');
        var chart = new CanvasJS.Chart("pieChart",
                {
                    title: {
                        text: "农机工作时间"
                    },
                    animationEnabled: true,
                    legend: {
                        verticalAlign: "bottom",
                        horizontalAlign: "center"
                    },
                    data: [
                        {
                            indexLabelFontSize: 20,
                            indexLabelFontFamily: "Monospace",
                            indexLabelFontColor: "darkgrey",
                            indexLabelLineColor: "darkgrey",
                            indexLabelPlacement: "outside",
                            type: "pie",
                            showInLegend: true,
                            toolTipContent: "{y} - <strong>#percent%</strong>",
                            dataPoints: j
                        }
                    ]
                });
        chart.render();
    }

</script>