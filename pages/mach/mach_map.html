---
layout: base_page
title: 农机跟踪
---

{% include mapScript.html %}
{% include temp/control_head.html %}

<div class="main_container">
    <div class="row full_height">
        <div class="col-md-9 map_part">
            <div class="row map_top">
                <div id="map_container"></div>
            </div>
            <div class="row map_bottom border">
                <div class="row ">
                    <div class="col-md-4 map_operation">
                        <div id="operation">
                            <p>
                                <input type="button" class="btn btn-info btn-mini" value="跳到当前位置"
                                       onclick="goCurrentPosition()"/>
                                <input type="button" class="btn btn-info btn-mini" value="跳转到双沟镇"
                                       onclick="goShuangGou()"/>
                            </p>
                            <p>
                                <input type="button" class="btn btn-info btn-mini" value="清除所有标记"
                                       onclick="clearAll()"/>

                                <input id="mapClickButton" type="button" class="btn btn-info btn-mini" value="启用点击坐标"
                                       onclick="shiftMapClick()"/>
                            </p>
                        </div>

                    </div>
                    <div class="col-md-8">
                        <ul class="list-group map_info">
                            <li id="successInfo" class="list-group-item list-group-item-success">
                                <span id="successNumber" class="badge">0</span>
                                <label></label>
                            </li>
                            <li id="infoInfo" class="list-group-item list-group-item-info">
                                <span id="infoNumber" class="badge">0</span>
                                <label></label>
                            </li>
                            <li id="warningInfo" class="list-group-item list-group-item-warning">
                                <span id="warningNumber" class="badge">0</span>
                                <label></label>
                            </li>
                            <li id="dangerInfo" class="list-group-item list-group-item-danger">
                                <span id="dangerNumber" class="badge">0</span>
                                <label></label>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 info_part ">
            <div class="row">
                <div class="col-md-12">
                    {% include temp/datetime.html id='dtp_start' addDays='-2' text='开始时间:' %}
                    {% include temp/datetime.html id='dtp_end' addDays='1' text='结束时间:' %}
                    {% include temp/textbox.html id='dtp_car' text='车牌号:' placeholder='请输入车牌号' showButton = true
                    onclick='onSearchClick()' onTextChange='onAutoSearch(value)' %}
                    {% include temp/simple_table.html %}
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    // 新建地图
    var machMap = new MachMap();
    // 新建表格
    var simpleTableGen = new SimpleTableGen();
    // gps记录
    var gpsRecordLine = new GpsRecordLine();
    var map = machMap.map;
    var apiObjUrl = API_URL + '/api/gpsRecords';

    // 本地存储上次的查询条件
    var startTime_local;
    var endTime_local;
    var carInfo_local;

    var settings = new Object();
    settings.columns = [{
        field: 'machCode',
        title: '车号',
        align: 'center',
    }, {
        field: 'machName',
        title: '车型',
        align: 'center',
    }, {
        field: 'gpsStartTime',
        title: '开始时间',
        formatter: simpleTableGen.shortDateFormatter,
        align: 'center',
    }, {
        field: 'gpsEndTime',
        title: '结束时间',
        formatter: simpleTableGen.shortDateFormatter,
        align: 'center',
    }];

    settings.onDblClickRow = function (row, $element) {
        onRowDbClick(row, $element);
    }

    var overLays = new Array();

    simpleTableGen.settings = settings;
    simpleTableGen.bind();

    function cleanLines() {
        overLays.forEach(function (overLay) {
            map.removeOverlay(overLay);
        });
        overLays = [];
    }

    //跳转到徐州双沟镇
    function goShuangGou() {
        var sgPoint = new BMap.Point(117.606257, 34.042178);
        var mk = new BMap.Marker(sgPoint);//添加标记点
        machMap.map.addOverlay(mk);
        machMap.map.panTo(sgPoint);
        machMap.map.setCenter(sgPoint);
    }

    //清除覆盖物
    function clearAll() {
        machMap.clearAll();
    }

    var fullData = null;

    // 自动查询本地缓存结果
    function onAutoSearch(value) {
        if (fullData == null) {
            fullData = simpleTableGen.table.bootstrapTable('getData');
        }
        var newData = new Array();
        fullData.forEach(function (item) {
            if (item.machCode.indexOf(value) > 0 || item.machName.indexOf(value) > 0) {
                newData.push(item);
            }
        });
        var checkCondition = value.length > carInfo_local.length && value.indexOf(carInfo_local) > 0 || (carInfo_local.length == 0 && value.length > 0);
        if (checkCondition) {
            simpleTableGen.table.bootstrapTable('load', newData);
        }
        else {
            simpleTableGen.table.bootstrapTable('load', fullData);
        }
        cleanAllInfo();
    }

    // 查询农机列表
    function onSearchClick() {
        fullData = null;
        startTime_local = $("#dtp_start").val();
        endTime_local = $("#dtp_end").val();
        carInfo_local = $("#dtp_car").val();


        var requestUrl = encodeURI(apiObjUrl + "?startTime=" + startTime_local + "&endTime=" + endTime_local + "&machCode=" + carInfo_local);
        $.get(requestUrl, function (result) {
            fullData = result;
            simpleTableGen.table.bootstrapTable('load', result);
        });
        cleanAllInfo();
    }

    var cssList = ['danger', 'warning', 'info', 'success'];
    var cssRemain = cssList.slice(0);
    function sortCss(a, b) {
        var result = cssList.indexOf(a) - cssList.indexOf(b);
        return cssList.indexOf(a) - cssList.indexOf(b);
    }
    // 双击选中行事件
    function onRowDbClick(row, $element) {
        var cssClass = $element.attr('class');
        if (cssClass) {
            $element.removeClass(cssClass);
            clearInfo(cssClass);
            cssRemain.push(cssClass);
            cssRemain.sort(sortCss);
            machMap.removeGpsRecords(row);
        }
        else {
            if (machMap.gpsRecordLines.size < 4) {
                cssClass = cssRemain.pop();
                cssRemain.sort(sortCss);
                $element.addClass(cssClass);
                var gpsLine = machMap.addGpsRecords(row, cssClass);
                writeInfo(row, cssClass, gpsLine);
            }
            else {
                alert("超过最大可选数!");
            }
        }
    }
    // 清除页面GPS信息框
    function clearInfo(cssClass) {
        writeInfo('', cssClass, '0');
    }
    // 写入页面GPS信息
    function writeInfo(info, cssClass, gpsLine) {
        var itemInfo = $("#" + cssClass + "Info");
        var countStr;
        var infoStr = '<label></label>';
        var gpsCount = 0;
        var co = 0.0015;
        var width = 3;

        if (info != '') {
            var totalLength = 0;
            var oldPoint = null;
            gpsLine.points.forEach(function (point) {
                if (oldPoint == null) {
                    oldPoint = point;
                }
                else {
                    totalLength += machMap.map.getDistance(point, oldPoint);
                    oldPoint = point;
                }
            });
            gpsCount = gpsLine.records.length;
            infoStr = info.machName + "\t" + info.machCode + ",总路长:" + totalLength.toFixed(2) + "米,作业宽度:" + width + ",作业面积:" + (totalLength * width * co).toFixed(2) + "亩";
        }
        countStr = '<span class="badge">' + gpsCount + '</span>'
        itemInfo.html(countStr + infoStr);
    }

    // 是否启用页面点击事件
    var enableMapClick = false;
    function shiftMapClick() {
        enableMapClick = !enableMapClick;
        machMap.enableMapClick(enableMapClick);
        var mapClickButton = $("#mapClickButton");
        if (enableMapClick) {
            mapClickButton.val("取消点击坐标");
        } else {
            mapClickButton.val("启用点击坐标");
        }
    }

    // 清除界面上所有GPS信息,并充值css列表
    function cleanAllInfo() {
        machMap.clearAll();
        cssList.forEach(function (css) {
            clearInfo(css);
        });
        cssRemain = cssList.slice(0);
    }

    onSearchClick();
    goShuangGou();

</script>